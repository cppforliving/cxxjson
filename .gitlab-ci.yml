image: registry.gitlab.com/attu/cxx

stages:
- build:gcc
- build:clang
- test:gcc
- test:clang
- post

.template: &gcc
  variables:
    CXX: g++

.template: &clang
  variables:
    CXX: clang++

.template: &libcxx
  variables:
    CXXFLAGS: -stdlib=libc++
    CXX: clang++
    LINKFLAGS: -stdlib=libc++

.template: &debug
  before_script:
  - source ./config/debug.sh

.template: &release
  before_script:
  - source ./config/release.sh

.template: &sanitize
  before_script:
  - source ./config/sanitize.sh

.template: &benchmark
  before_script:
  - source ./config/release.sh
  after_script:
  - ./waf benchmark

.template: &coverage
  stage: post
  before_script:
  - source ./config/coverage.sh
  after_script:
  - >-
     gcovr
     --branch
     --root=build
     --filter='.*cxx.*'
     --filter='.*src.*'
     --print-summary

.template: &build
  script:
  - ./waf configure --prefix=usr build install --destdir=/

gcc:debug:
  stage: build:gcc
  <<: *gcc
  <<: *debug
  <<: *build

gcc:release:
  stage: build:gcc
  <<: *gcc
  <<: *release
  <<: *build

clang:libstdc++:debug:
  stage: build:clang
  <<: *clang
  <<: *debug
  <<: *build

clang:libstdc++:release:
  stage: build:clang
  <<: *clang
  <<: *release
  <<: *build

clang:libcxx:debug:
  stage: build:clang
  <<: *libcxx
  <<: *debug
  <<: *build

clang:libcxx:release:
  stage: build:clang
  <<: *libcxx
  <<: *release
  <<: *build

gcc:sanitize:
  stage: test:gcc
  <<: *gcc
  <<: *sanitize
  <<: *build

clang:libstdc++:sanitize:
  stage: test:clang
  <<: *clang
  <<: *sanitize
  <<: *build

clang:libcxx:sanitize:
  stage: test:clang
  <<: *libcxx
  <<: *sanitize
  <<: *build

gcc:benchmark:
  stage: test:gcc
  <<: *gcc
  <<: *benchmark
  <<: *build

clang:libstdc++:benchmark:
  stage: test:clang
  <<: *clang
  <<: *benchmark
  <<: *build

gcc:coverage:
  <<: *gcc
  <<: *coverage
  <<: *build

clang:fuzzer:
  stage: post
  <<: *clang
  <<: *release
  script:
    - ./waf configure fuzzer
